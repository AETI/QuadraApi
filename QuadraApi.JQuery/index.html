<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="https://quadra.aeti-inc.com/favicon.ico">
    <title>Quadra API</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet" />
	<link href="http://getbootstrap.com/examples/starter-template/starter-template.css" rel="stylesheet" />
	<style>
		#data { display: none; }
		#login { max-width: 400px; margin: auto;}
		.modal-dialog { padding-top: 15%; }
		#table-wrap { overflow: scroll; height: 400px; }
	</style>
	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->	
</head>
<body>

	<nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">          
          <a class="navbar-brand" href="#">Quadra API</a>
        </div>        
      </div>
    </nav>

    <div class="container">
      <div class="starter-template">        
        <p class="lead">This page illustrates authenticating to the Quadra API and retrieving JSON using JQuery.</p>
      </div>
    </div>
	
	<div id="login" class="container">		
		<form class="form">
		  <div class="form-group">
			<label for="quadraUrlTextbox">Quadra Url</label>
			<input type="text" class="form-control" id="quadraUrlTextbox" placeholder="https://quadra.aeti-inc.com" value="http://quadradev.aeti-inc.com">
		  </div>
		  <div class="form-group">
			<label for="emailTextbox">Email</label>
			<input type="text" class="form-control" id="emailTextbox" placeholder="jane.doe@example.com">
		  </div>
		  <div class="form-group">
			<label for="passwordTextbox">Password</label>
			<input type="password" class="form-control" id="passwordTextbox" placeholder="jane.doe@example.com">
		  </div>		  
		  <button onclick="GetAccessToken();" class="btn btn-default">Login</button>
		</form>
	</div>
	
	<div id="data" class="container">	
		<div class="btn-group" role="group">
		  <button data-url="/api/items" class="btn btn-default">Get Items</button>
		  <button data-url="/api/otherexposures" class="btn btn-default">Get Others</button>
		  <button data-url="/api/structures" class="btn btn-default">Get Structures</button>
		  <button data-url="/api/vehicles" class="btn btn-default">Get Vehicles</button>
		</div>	
		<br /><br />
		<div id="table-wrap">
			<table id="dataTable" class="table table-striped table-bordered">
				<thead>
					<tr>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		
	</div>
	
	<div class="modal" id="pleaseWait">
		<div class="modal-dialog">
			 <div class="modal-content">
				<div class="modal-header">
					<h4>Calling API...</h4>
				</div>
				<div class="modal-body">					
					<div class="progress progress-striped active">
					  <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;">						
					  </div>
					</div>
				</div>
			</div>
		</div>		
    </div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> 
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script>
        var _accessToken = '';
		
		$(document).ready(function() {
			PleaseWait(false);
			$("#data button").click(function() {
				GetData($(this).attr("data-url"));
			});
		});
		
		function GetAccessToken() {			
			var baseUrl = $("#quadraUrlTextbox").val();
			
			PleaseWait(true);

						
			// Build form data
			var userName = $("#emailTextbox").val();
			var password = $("#passwordTextbox").val();
			var postData = "grant_type=password&userName=" + userName + 
				"&password=" + password;		
				
			// POST to Quarda API for access token
			$.ajax({
				data: postData,
				type: "POST",
				url: baseUrl + "/Token",				
				dataType: "json"                
			}).done(function(data) {
				$("#passwordTextbox").val("");
			
				// Show data options
				_accessToken = data.access_token;
				$("#login").fadeOut(function() { 
					$("#data").fadeIn();
				});		

				PleaseWait(false);				
			})
			.fail(function(jqXHR, textStatus, errorThrown) {				
				PleaseWait(false);
				
				alert( jqXHR.responseText );
			});
		}
				
        function GetData(dataUrl)  {
			var baseUrl = $("#quadraUrlTextbox").val();
			
			PleaseWait(true);
			
			// Clear columns
			$("#dataTable th").remove();
			$("#dataTable tbody tr").remove();
			
			// GET data from Quadra API
			$.ajax({
                type: "GET",
                url: baseUrl + dataUrl,
                dataType: "json",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + _accessToken);
				}
			}).done(function(data) {							
				
				if(data.length > 0)  {				
					// Add columns
					for (var name in data[0]) {
						$("#dataTable thead tr").append("<th data-field='" + name + "'>" + name + "</th>");
					}
					
					// Add rows
					for(var row in data) {						
						var rowHtml = '<tr>';						
						for (var name in data[row]) {
							rowHtml += '<td>' + (data[row][name] == null ? '' : data[row][name]) + '</td>';
						}						
						rowHtml+= '</tr>';
						$("#dataTable tbody").append(rowHtml);
					}					
				}
				
				PleaseWait(false);
			})
			.fail(function(jqXHR, textStatus, errorThrown) {
				PleaseWait(false);
				
				alert( jqXHR.responseText );
			});
        }       

		function PleaseWait(show) {
			if(show) {
				$("#pleaseWait").modal();
			} else {
				$("#pleaseWait").modal('hide');
			}
		}

    </script>
</body>
</html>